<!doctype html>

<head>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.3/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.3/themes/base/jquery-ui.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>

</head>

<body>

    <button onclick="run()">Run</button>

    <h3 id="Freq"># Hz</h3>
    <h2 id="Note">X0</h2>
    <p id="thdn">THD+N</p>
    <p id="harmnonicsratio">Harmonics/non-harmonics ratio</p>
    <div id="fftChart" style="width: 600px;height:300px;"></div>
    <div id="harmonicsChart" style="width: 600px;height:400px;"></div>


    <script>
        $(function () {
            $(" #thdbar").progressbar({ value: 0 });
        }); </script>

    <script>
        function indexOfMax(arr) {
            if (arr.length === 0) {
                return -1;
            }

            var max = arr[0];
            var maxIndex = 0;

            for (var i = 1; i < arr.length; i++) {
                if (arr[i] > max) {
                    maxIndex = i;
                    max = arr[i];
                }
            }

            return maxIndex;
        }
    </script>

    <script>
        function getNotesDict(a4tuning) {
            // 12 equal temperament system :
            // f = 2^(h/12) x tuningf
            // where h is the number of semitones (half steps) above or below tuning reference (e.g. A4: 440Hz)

            var pitchDict = {}
            var notesArray = ["A", "Bb", "B", "C", "C#", "D", "Eb", "E", "F", "F#", "G", "G#"]
            var a0tuning = Math.pow(2, (-12 * 4) / 12) * a4tuning;
            for (var octave = 0; octave < 6; octave++) {
                for (var note = 0; note < 12; note++) {
                    var _note = notesArray[note].concat(octave.toString());
                    var _freq = Math.pow(2, (12 * octave + note) / 12) * a0tuning;
                    pitchDict[_note] = _freq;
                }
            }
            return pitchDict;
        }

        function findClosestNote(freq, tuning) {
            var _freqDiff = 9999;
            var _notename = ""
            for (const [key, value] of Object.entries(getNotesDict(tuning))) {
                if (Math.abs(freq - value) < _freqDiff) {
                    _freqDiff = Math.abs(freq - value);
                    _notename = key
                }
            }
            return _notename
        }
    </script>

    <script>
        const TIMECONSTANT = 50;
        function run() {
            const tuningFreq = 440;
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            audioCtx.resume();
            let source;
            const constraints = { audio: true };

            var notesDict = getNotesDict(tuningFreq);

            var fftChart = echarts.init(document.getElementById('fftChart'));
            var fftChartOptions = {
                title: {
                    text: "FFT"
                },
                xAxis: {
                    type: 'log',
                    min: 20,
                    max: 20000
                },
                yAxis: {
                    type: 'value'
                },
                series: [
                    {
                        data: [],
                        type: 'line',
                        showSymbol: false,
                    }
                ],
                animation: false
            }
            fftChart.setOption(fftChartOptions);

            var harmonicsChart = echarts.init(document.getElementById('harmonicsChart'));
            var harmonicsChartOptions = {
                title: { text: 'Harmonics' },
                xAxis: {
                    type: 'category',
                    data: ['f0', 'f1', 'f2', 'f3', 'f4', 'f5', 'f6', 'f7', 'f8', 'non-harmonics']
                },
                yAxis: { type: 'log', min: 1 },
                series: [{ data: [], type: 'bar' }],
                animation: false
            }
            harmonicsChart.setOption(harmonicsChartOptions)

            navigator.mediaDevices
                .getUserMedia(constraints)
                .then((stream) => {
                    source = audioCtx.createMediaStreamSource(stream);

                    const analyser = audioCtx.createAnalyser();
                    analyser.fftSize = 512 * 4;

                    const bufferLength = analyser.frequencyBinCount;
                    var dataArray = new Float32Array(bufferLength);
                    var freqAmpArray = new Float32Array(bufferLength);

                    var pitchDict = getNotesDict(tuningFreq);

                    source.connect(analyser);

                    var freqValues = new Float32Array(bufferLength);
                    for (let i = 0; i < bufferLength; i++) {
                        freqValues[i] = audioCtx.sampleRate / bufferLength * i / 2;
                    }

                    setInterval(() => {
                        // TODO add A-weighted filter
                        analyser.getFloatTimeDomainData(dataArray);
                        analyser.getFloatFrequencyData(freqAmpArray);

                        freqAmpArray = freqAmpArray.map((x) => x + 96);  // 96 for bit depth 16

                        var if0 = indexOfMax(freqAmpArray);
                        var f0 = freqValues[if0];

                        // find closest note
                        var closestNote = findClosestNote(f0, tuningFreq);
                        $("#Note").text(closestNote);
                        $("#Freq").text(Math.round(f0).toString() + " Hz");

                        var _plotArray = [];
                        for (let i = 0; i < freqAmpArray.length; i++) {
                            _plotArray.push([freqValues[i], freqAmpArray[i]])
                        }
                        fftChartOptions.series[0].data = _plotArray;
                        fftChart.setOption(fftChartOptions);


                        const fftIndexLookup = 4;
                        // calculate THD+N
                        var f0Pow = 0;
                        var nonf0Pow = 0;
                        for (let i = 0; i < freqAmpArray.length; i++) {
                            if (Math.abs(i - if0) <= fftIndexLookup) {
                                f0Pow = Math.pow(10, freqAmpArray[i] / 20) + f0Pow;
                            }
                            else {
                                nonf0Pow = Math.pow(10, freqAmpArray[i] / 20) + nonf0Pow;
                            }
                        }
                        var thdn = nonf0Pow / f0Pow;
                        $("#thdn").text("THD+N: " + Math.round(thdn) + "%");

                        // calculate non-harmonic power
                        var harmonicIndices = [];

                        // calculate THD
                        // fN power
                        const nHarmonics = 8;
                        var harmonicsPowerArray = []
                        for (let n = 1; n <= nHarmonics + 1; n++) {
                            var harmPow = 0;
                            for (let i = -fftIndexLookup; i <= fftIndexLookup; i++) {
                                harmPow = Math.pow(10, freqAmpArray[if0 * n + i] / 20) + harmPow;
                                harmonicIndices.push(i);
                            }
                            harmonicsPowerArray.push(harmPow);
                        }

                        // back to non harmonic
                        var nonHarmPow = 0;
                        var fnPow = 0;
                        for (let i = 0; i < freqAmpArray.length; i++) {
                            if (!(harmonicIndices.includes(i))) {
                                nonHarmPow = Math.pow(10, freqAmpArray[i] / 20) + nonHarmPow;
                            } else {
                                fnPow = Math.pow(10, freqAmpArray[i] / 20) + fnPow;
                            }
                        }
                        // console.log(nonHarmPow);
                        // adding non harm power at the and for plotting
                        harmonicsPowerArray.push(nonHarmPow);
                        $("#harmnonicsratio").text("Harm/non-harm ratio= " + Math.round(fnPow / nonHarmPow * 100) + "%");

                        harmonicsChartOptions.series[0].data = harmonicsPowerArray;
                        harmonicsChart.setOption(harmonicsChartOptions);

                        // var thdbarvalue = harmPow / (f0Pow + harmPow) * 100;
                        // $("#thdbar").progressbar("value", thdbarvalue);
                        // console.log(thdbarvalue);

                        // console.log(freqArray);
                        // console.log(fftValues);
                        // console.log(freqAmpArray);
                    }, TIMECONSTANT)


                })
                .catch(function (err) {
                    console.error("The following gUM error occured: " + err);
                    audioCtx.close();
                }, TIMECONSTANT);
        }

    </script>
</body>